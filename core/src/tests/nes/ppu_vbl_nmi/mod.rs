
use crate::emulation::nes::Nes;

#[cfg(test)]
mod even_odd_frames_09;
#[cfg(test)]
mod even_odd_timing_10;
#[cfg(test)]
mod nmi_control_04;
#[cfg(test)]
mod nmi_off_timing_08;
#[cfg(test)]
mod nmi_on_timing_07;
#[cfg(test)]
mod nmi_timing_05;
#[cfg(test)]
mod suppression_06;
#[cfg(test)]
mod vbl_basics_01;
#[cfg(test)]
mod vbl_clear_time_03;
#[cfg(test)]
mod vbl_set_time_02;

#[test]
fn test_ppu_vbl_nmi() {
    let mut emu = Nes::default();
    emu.load_rom(&String::from(
        "./tests/nes-test-roms/ppu_vbl_nmi/ppu_vbl_nmi.nes",
    ));
    emu.power();
    emu.run_until(650_000_000)
        .expect("Error while running test");

    let whole_mem = emu.get_memory_debug(Some(0x6000..=0x6079));
    let cpu_mem = whole_mem[0].as_slice();

    let expected = [
        0x00, 0xDE, 0xB0, 0x61, 0x54, 0x2B, 0x20, 0x31, 0x20, 0x32, 0x0A, 0x30, 0x30, 0x20, 0x2D,
        0x20, 0x56, 0x0A, 0x30, 0x31, 0x20, 0x2D, 0x20, 0x56, 0x0A, 0x30, 0x32, 0x20, 0x2D, 0x20,
        0x56, 0x0A, 0x30, 0x33, 0x20, 0x2D, 0x20, 0x56, 0x0A, 0x30, 0x34, 0x20, 0x2D, 0x20, 0x2D,
        0x0A, 0x30, 0x35, 0x20, 0x56, 0x20, 0x2D, 0x0A, 0x30, 0x36, 0x20, 0x56, 0x20, 0x2D, 0x0A,
        0x30, 0x37, 0x20, 0x56, 0x20, 0x2D, 0x0A, 0x30, 0x38, 0x20, 0x56, 0x20, 0x2D, 0x0A, 0x0A,
        0x30, 0x32, 0x2D, 0x76, 0x62, 0x6C, 0x5F, 0x73, 0x65, 0x74, 0x5F, 0x74, 0x69, 0x6D, 0x65,
        0x0A, 0x0A, 0x50, 0x61, 0x73, 0x73, 0x65, 0x64, 0x0A, 0x41, 0x6C, 0x6C, 0x20, 0x31, 0x30,
        0x20, 0x74, 0x65, 0x73, 0x74, 0x73, 0x20, 0x70, 0x61, 0x73, 0x73, 0x65, 0x64, 0x0A, 0x0A,
        0x0A, 0x00,
    ];

    assert_eq!(cpu_mem[0], 0);
    assert_eq!(&cpu_mem[..expected.len()], &expected);
}
